<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; line-height: 1.4; color: #333; }
      .field { margin-bottom: 15px; }
      label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
      select, input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
      button { background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
      button:hover { background-color: #357ae8; }
      button:disabled { background-color: #ccc; cursor: not-allowed; }
      .error { color: #d93025; font-size: 12px; margin-top: 5px; display: none; }
      #status { margin-top: 15px; font-size: 14px; text-align: center; }
      .success { color: #1e8e3e; font-weight: bold; }
      .warning { color: #f9ab00; font-weight: bold; }
      #downloadLink { display: none; margin-top: 10px; text-align: center; }
      #downloadLink a { color: #4285f4; font-weight: bold; text-decoration: none; border-bottom: 1px solid #4285f4; }
      #exceptionReport { display: none; margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #f9ab00; border-radius: 4px; }
      #exceptionReport a { color: #d93025; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="field">
      <label for="sheetSelect">Entries Sheet</label>
      <select id="sheetSelect"></select>
    </div>

    <div class="field">
      <label for="meetTable">Meet Table Name</label>
      <input type="text" id="meetTable" value="Meet">
    </div>

    <div class="field">
      <label for="schoolsTable">Schools Table Name</label>
      <input type="text" id="schoolsTable" value="Schools">
    </div>

    <div class="field">
      <label for="fileName">Output File Name</label>
      <input type="text" id="fileName" placeholder="auto-generated if blank">
    </div>

    <button id="generateBtn">Generate SD3 File</button>

    <div id="status"></div>
    <div id="downloadLink">
      <a href="#" id="fileUrl" target="_blank">Download .sd3 File</a>
    </div>
    <div id="exceptionReport">
      <strong>⚠️ Warning:</strong> <span id="exceptionCount"></span> issue(s) detected during export.<br>
      <a href="#" id="reportUrl" target="_blank">View Exception Report</a>
    </div>

    <script>
      const generateBtn = document.getElementById('generateBtn');
      const status = document.getElementById('status');
      const downloadLink = document.getElementById('downloadLink');
      const fileUrl = document.getElementById('fileUrl');
      const sheetSelect = document.getElementById('sheetSelect');
      const exceptionReport = document.getElementById('exceptionReport');
      const exceptionCount = document.getElementById('exceptionCount');
      const reportUrl = document.getElementById('reportUrl');

      // Initialize sheet list
      google.script.run.withSuccessHandler(sheets => {
        sheets.forEach(sheet => {
          const opt = document.createElement('option');
          opt.value = sheet;
          opt.textContent = sheet;
          sheetSelect.appendChild(opt);
        });
      }).withFailureHandler(err => {
        status.textContent = "Error loading sheets: " + err.message;
      }).getVisibleSheetNames();

      generateBtn.addEventListener('click', () => {
        const sheetName = sheetSelect.value;
        const meetTable = document.getElementById('meetTable').value;
        const schoolsTable = document.getElementById('schoolsTable').value;
        const fileName = document.getElementById('fileName').value;

        if (!sheetName) {
          status.textContent = "Please select an entries sheet.";
          return;
        }

        generateBtn.disabled = true;
        status.textContent = "Generating SDIF file... please wait.";
        status.className = "";
        downloadLink.style.display = "none";
        exceptionReport.style.display = "none";

        google.script.run
          .withSuccessHandler(result => {
            // Handle both old format (string) and new format (object)
            if (typeof result === 'string') {
              // Old format - just the URL
              status.textContent = "Successfully generated!";
              status.className = "success";
              fileUrl.href = result;
              downloadLink.style.display = "block";
            } else {
              // New format - object with sdifFileUrl, reportUrl, exceptionCount
              if (result.exceptionCount > 0) {
                status.textContent = "Generated with warnings - please review exception report.";
                status.className = "warning";
                exceptionCount.textContent = result.exceptionCount;
                reportUrl.href = result.reportUrl;
                exceptionReport.style.display = "block";
              } else {
                status.textContent = "Successfully generated!";
                status.className = "success";
              }
              fileUrl.href = result.sdifFileUrl;
              downloadLink.style.display = "block";
            }
            generateBtn.disabled = false;
          })
          .withFailureHandler(err => {
            status.textContent = "Error: " + err.message;
            status.className = "error";
            status.style.display = "block";
            generateBtn.disabled = false;
          })
          .processSheetToSd3(sheetName, meetTable, schoolsTable, fileName);
      });
    </script>
  </body>
</html>
